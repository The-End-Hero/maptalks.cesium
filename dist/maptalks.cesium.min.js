/*!
 * maptalks.cesium v0.0.0
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@<2.0.0 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("Cesium")):"function"==typeof define&&define.amd?define(["exports","maptalks","Cesium"],t):t(e.maptalks=e.maptalks||{},e.maptalks,e.Cesium)}(this,function(e,t,n){"use strict";function r(e,t){for(var n=Object.getOwnPropertyNames(t),r=0;r<n.length;r++){var i=n[r],a=Object.getOwnPropertyDescriptor(t,i);a&&a.configurable&&void 0===e[i]&&Object.defineProperty(e,i,a)}return e}function i(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function a(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):r(e,t))}function s(e){return e*Math.PI/180}var c={sceneOptions:null,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0},p=function(e){function t(){return i(this,t),a(this,e.apply(this,arguments))}return o(t,e),t.prototype.getCesiumScene=function(){var e=this._getRenderer();return e?e.scene:null},t.prototype.getCameraAltitude=function(){if(!this._getRenderer())return 0;var e=this.getCesiumScene().camera;return n.Ellipsoid.WGS84.cartesianToCartographic(e.position).height},t.prototype.redraw=function(){var e=this._getRenderer();return e?e.setToRedraw():null},t}(t.CanvasLayer);p.mergeOptions(c);var u=function(e){function r(){return i(this,r),a(this,e.apply(this,arguments))}return o(r,e),r.prototype.needToRedraw=function(){return!0},r.prototype.onAdd=function(){this.prepareCanvas()},r.prototype._adjust=function(e){var t=this.canvas.height/2;return e.y+=(e.y-t)/t*20,e},r.prototype.draw=function(){this.prepareCanvas(),this._locateCamera(),this._renderCesiumScene(),this.completeRender()},r.prototype.drawOnInteracting=function(){this.prepareCanvas(),this._locateCamera(),this._renderCesiumScene(),this.completeRender()},r.prototype.createContext=function(){document.createElement("div").appendChild(this.canvas);var e=this.layer.options.sceneOptions||{};e=t.Util.extend(e,{canvas:this.canvas,scene3DOnly:!0}),this.scene=new n.Scene(e),this.scene.camera.constrainedAxis=n.Cartesian3.UNIT_Z,this.scene.camera.fov=Math.PI/2,this.globe=new n.Globe(n.Ellipsoid.WGS84),this.globe.baseColor=n.Color.WHITE,this.scene.globe=this.globe,this.scene.skyAtmosphere=new n.SkyAtmosphere},r.prototype.clearCanvas=function(){this.canvas},r.prototype.resizeCanvas=function(t){e.prototype.resizeCanvas.call(this,t),this.canvas&&(this.scene.camera.frustum.aspectRatio=this.canvas.width/this.canvas.height)},r.prototype._sceneReady=function(){if(this.scene.terrainProvider&&!this.scene.terrainProvider.ready)return!1;if(this.scene.imageryLayers)for(var e=this.scene.imageryLayers,t=e.length,n=0;n<t;n++)if(!e.get(n).imageryProvider.ready)return!1;return!0},r.prototype._renderCesiumScene=function(){this.scene.initializeFrame(),this.scene.render(n.JulianDate.now())},r.prototype._locateCamera=function(){var e=this.getMap(),t=e.getCenter(),r=this.scene;if(t){var i=t.toArray(),a=new n.Cartographic(s(i[0]),s(i[1]));if(r.globe){var o=r.globe.getHeight(a);a.height=o||0}var c=n.Ellipsoid.WGS84.cartographicToCartesian(a),p={pitch:s(e.getPitch())-Math.PI/2,heading:s(e.getBearing()),roll:void 0};r.camera.setView({destination:c,orientation:p});var u=this._calcDistance(e);r.camera.moveBackward(u)}},r.prototype._calcDistance=function(e){var t=this.canvas,n=this.scene.camera.frustum.fov,r=e.getCenter(),i=e.locateByPoint(r,t.width,0);return e.computeLength(r,i)/2/Math.tan(n/2)},r.prototype._calcDistanceForResolution2=function(e,t){var n=this.canvas,r=this.scene.camera.frustum.fov,i=e;return n.width*i*Math.cos(Math.abs(t))/2/Math.tan(r/2)},r}(t.renderer.CanvasRenderer);p.registerRenderer("canvas",u),e.CesiumLayer=p,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.cesium v0.0.0, requires maptalks@<2.0.0.")});