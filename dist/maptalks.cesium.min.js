/*!
 * maptalks.cesium v0.0.0
 * LICENSE : MIT
 * (c) 2016-2018 maptalks.org
 */
/*!
 * requires maptalks@<2.0.0 
 */
!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("maptalks"),require("Cesium")):"function"==typeof define&&define.amd?define(["exports","maptalks","Cesium"],t):t(e.maptalks=e.maptalks||{},e.maptalks,e.Cesium)}(this,function(e,t,r){"use strict";function n(e,t){for(var r=Object.getOwnPropertyNames(t),n=0;n<r.length;n++){var a=r[n],i=Object.getOwnPropertyDescriptor(t,a);i&&i.configurable&&void 0===e[a]&&Object.defineProperty(e,a,i)}return e}function a(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function o(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):n(e,t))}function s(e){return e*Math.PI/180}var c={sceneOptions:null,forceRenderOnZooming:!0,forceRenderOnMoving:!0,forceRenderOnRotating:!0},h=function(e){function t(){return a(this,t),i(this,e.apply(this,arguments))}return o(t,e),t.prototype.getCesiumScene=function(){var e=this._getRenderer();return e?e.scene:null},t.prototype.getCameraAltitude=function(){if(!this._getRenderer())return 0;var e=this.getCesiumScene().camera;return r.Ellipsoid.WGS84.cartesianToCartographic(e.position).height},t.prototype.redraw=function(){var e=this._getRenderer();return e?e.setToRedraw():null},t}(t.CanvasLayer);h.mergeOptions(c);var p=[112,112,112,255],u=function(e){function n(){return a(this,n),i(this,e.apply(this,arguments))}return o(n,e),n.prototype.needToRedraw=function(){return!0},n.prototype.onAdd=function(){this.prepareCanvas()},n.prototype._adjust=function(e){var t=this.canvas.height/2;return e.y+=(e.y-t)/t*20,e},n.prototype.draw=function(){this.prepareCanvas(),this._locateCamera(),this._renderCesiumScene(),this.completeRender()},n.prototype.drawOnInteracting=function(){this.prepareCanvas(),this._locateCamera(),this._renderCesiumScene(),this.completeRender()},n.prototype.createContext=function(){document.createElement("div").appendChild(this.canvas);var e=this.layer.options.sceneOptions||{};e=t.Util.extend(e,{canvas:this.canvas,scene3DOnly:!0}),this.scene=new r.Scene(e),this.scene.fog.enabled=!1,this.scene.backgroundColor=new r.Color(p[0]/255,p[1]/255,p[2]/255,1),this.scene.camera.constrainedAxis=r.Cartesian3.UNIT_Z,this.globe=new r.Globe(r.Ellipsoid.WGS84),this.globe.baseColor=new r.Color(p[0]/255,p[1]/255,p[2]/255,1),this.scene.globe=this.globe},n.prototype.clearCanvas=function(){this.canvas},n.prototype.getCanvasImage=function(){var r=e.prototype.getCanvasImage.call(this);if(!r||!r.image)return r;var n=r.image;this.buffer||(this.buffer=document.createElement("canvas"),t.Browser.retina&&this.buffer.getContext("2d").scale(2,2));var a=this.buffer,i=a.width=n.width,o=a.height=n.height,s=a.getContext("2d");s.drawImage(n,0,0);for(var c=s.getImageData(0,0,i,o),h=c.data,u=0,f=h.length;u<f;u+=4)if(h[u]===p[0]&&h[u+1]===p[1]&&h[u+2]===p[2])h[u+3]=0;else if(this.layer.options.gray){var l=[h[u]+h[u+1]+h[u+2]]/3;h[u]=l,h[u+1]=l,h[u+2]=l}return s.putImageData(c,0,0),r.image=a,r},n.prototype.resizeCanvas=function(t){e.prototype.resizeCanvas.call(this,t),this.canvas&&(this.scene.camera.frustum.aspectRatio=this.canvas.width/this.canvas.height)},n.prototype._sceneReady=function(){if(this.scene.terrainProvider&&!this.scene.terrainProvider.ready)return!1;if(this.scene.imageryLayers)for(var e=this.scene.imageryLayers,t=e.length,r=0;r<t;r++)if(!e.get(r).imageryProvider.ready)return!1;return!0},n.prototype._renderCesiumScene=function(){this.scene.initializeFrame(),this.scene.render(r.JulianDate.now())},n.prototype._locateCamera=function(){var e=this.getMap(),t=e.getCenter(),n=this.scene;if(t){var a=void 0;a=this.canvas.height>this.canvas.width?e.getFov()*Math.PI/180:e.getFov()*Math.PI/180*this.canvas.width/this.canvas.height,n.camera.frustum.fov=a;var i=t.toArray(),o=s(e.getPitch()),c=this._calcDistance(e),h=new r.Cartographic(s(i[0]),s(i[1]));if(n.globe){var p=n.globe.getHeight(h);h.height=p||0}var u=r.Ellipsoid.WGS84.cartographicToCartesian(h),f={pitch:o-Math.PI/2,heading:s(e.getBearing()),roll:void 0};n.camera.setView({destination:u,orientation:f}),n.camera.moveBackward(c)}},n.prototype._calcDistance=function(e){var t=this.canvas,r=this.scene.camera.frustum.fov,n=e.getCenter(),a=e.locateByPoint(n,-t.width/2,0),i=e.locateByPoint(n,t.width/2,0);return e.computeLength(i,a)/2/Math.tan(r/2)},n}(t.renderer.CanvasRenderer);h.registerRenderer("canvas",u),e.CesiumLayer=h,Object.defineProperty(e,"__esModule",{value:!0}),"undefined"!=typeof console&&console.log("maptalks.cesium v0.0.0, requires maptalks@<2.0.0.")});